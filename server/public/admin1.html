<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Guest Management</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Cinzel', serif;
            background: linear-gradient(135deg, #f0e8e8 0%, #f5f0f5 50%, #e8f0f0 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.9);
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        h1 {
            color: #6a5a6a;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #8a7a8a;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .venue-info {
            margin-top: 10px;
            color: #a88b98;
            font-size: 13px;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            gap: 15px;
            flex-wrap: wrap;
        }

        .actions {
            display: flex;
            gap: 15px;
        }

        .zoom-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-family: 'Cinzel', serif;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #a88b98;
            color: white;
        }

        .btn-primary:hover {
            background: #9d7f9d;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(168, 139, 152, 0.3);
        }

        .btn-zoom {
            background: white;
            color: #6a5a6a;
            border: 2px solid #d4b8c8;
            padding: 8px 16px;
            font-size: 18px;
        }

        .btn-zoom:hover {
            background: #f9f5f7;
            border-color: #a88b98;
        }

        input[type="file"] {
            display: none;
        }

        .file-upload-label {
            display: inline-block;
            padding: 12px 24px;
            background: #b89ab8;
            color: white;
            border-radius: 8px;
            font-family: 'Cinzel', serif;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-upload-label:hover {
            background: #a88b98;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(184, 154, 184, 0.3);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            text-align: center;
        }

        .stat-number {
            font-size: 36px;
            color: #a88b98;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            color: #8a7a8a;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .floor-plan-wrapper {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            padding: 30px;
            overflow: auto;
            position: relative;
        }

        .floor-plan {
            position: relative;
            width: 1200px;
            height: 900px;
            background: #fafafa;
            margin: 0 auto;
            transform-origin: top left;
            transition: transform 0.3s;
        }

        .stage {
            position: absolute;
            top: 80px;
            left: 420px;
            width: 360px;
            height: 120px;
            background: linear-gradient(135deg, #e8d8e8 0%, #d8c8d8 100%);
            border: 2px solid #b89ab8;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: #6a5a6a;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .table-circle {
            position: absolute;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: white;
            border: 3px solid #d4b8c8;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .table-circle:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(168, 139, 152, 0.3);
            border-color: #a88b98;
            z-index: 10;
        }

        .table-circle.occupied {
            background: linear-gradient(135deg, #d8f0d8 0%, #c8e8c8 100%);
            border-color: #88b888;
        }

        .table-number {
            font-size: 14px;
            color: #6a5a6a;
            font-weight: 600;
        }

        .table-rect {
            position: absolute;
            width: 80px;
            height: 50px;
            background: white;
            border: 3px solid #d4b8c8;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .table-rect:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(168, 139, 152, 0.3);
            border-color: #a88b98;
            z-index: 10;
        }

        .table-rect.occupied {
            background: linear-gradient(135deg, #d8f0d8 0%, #c8e8c8 100%);
            border-color: #88b888;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            max-width: 700px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
        }

        .modal-header {
            margin-bottom: 25px;
        }

        .modal-header h2 {
            color: #6a5a6a;
            font-size: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #6a5a6a;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #d4b8c8;
            border-radius: 8px;
            font-family: 'Cinzel', serif;
            font-size: 14px;
            outline: none;
        }

        .form-group input:focus {
            border-color: #a88b98;
        }

        .modal-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 30px;
        }

        .btn-cancel {
            background: #ccc;
            color: #666;
        }

        .btn-cancel:hover {
            background: #bbb;
        }

        .guest-list {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .guest-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f9f5f7;
            border-radius: 6px;
            margin-bottom: 10px;
        }

        .guest-name {
            color: #6a5a6a;
            font-size: 14px;
        }

        .btn-edit {
            background: #88b8d8;
            color: white;
            padding: 6px 12px;
            font-size: 11px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        .btn-edit:hover {
            background: #78a8c8;
        }

        .btn-remove {
            background: #d88888;
            color: white;
            padding: 6px 12px;
            font-size: 11px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        .btn-remove:hover {
            background: #c87878;
        }

        .extra-guests-section {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px solid #f0e8f0;
        }

        .section-title {
            font-size: 14px;
            color: #6a5a6a;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .extra-guest-entry {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: end;
        }

        .extra-guest-entry input {
            flex: 1;
        }

        .btn-add-extra {
            background: #88b8d8;
            color: white;
            padding: 12px 20px;
            font-size: 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-family: 'Cinzel', serif;
        }

        .btn-add-extra:hover {
            background: #78a8c8;
        }

        .btn-remove-extra {
            background: #d88888;
            color: white;
            padding: 12px 16px;
            font-size: 11px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            flex-shrink: 0;
        }

        .btn-remove-extra:hover {
            background: #c87878;
        }

        .extra-count-section {
            margin-top: 20px;
            padding: 20px;
            background: #f9f5f7;
            border-radius: 8px;
        }

        .extra-count-section label {
            display: block;
            margin-bottom: 10px;
            font-size: 13px;
            color: #6a5a6a;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .extra-count-section input {
            width: 100%;
            padding: 12px;
            border: 2px solid #d4b8c8;
            border-radius: 8px;
            font-family: 'Cinzel', serif;
            font-size: 14px;
            outline: none;
        }

        .extra-count-section p {
            font-size: 12px;
            color: #8a7a8a;
            margin-top: 8px;
            font-style: italic;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .extra-guest-entry {
                flex-direction: column;
                align-items: stretch;
            }
        }

        @media (max-width: 1400px) {
            .floor-plan {
                width: 1000px;
                height: 750px;
            }
        }

        @media (max-width: 1200px) {
            .floor-plan {
                width: 900px;
                height: 675px;
            }

            .table-circle {
                width: 45px;
                height: 45px;
            }

            .table-number {
                font-size: 12px;
            }
        }

        @media (max-width: 992px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .actions {
                flex-wrap: wrap;
            }

            .floor-plan {
                width: 800px;
                height: 600px;
            }
        }

        @media (max-width: 768px) {
            .header {
                padding: 20px;
            }

            h1 {
                font-size: 24px;
            }

            .floor-plan {
                width: 600px;
                height: 450px;
            }

            .table-circle {
                width: 38px;
                height: 38px;
            }

            .table-number {
                font-size: 10px;
            }

            .stage {
                font-size: 12px;
            }
        }

        @media (max-width: 576px) {
            .floor-plan-wrapper {
                padding: 15px;
            }

            .floor-plan {
                width: 500px;
                height: 375px;
            }

            .table-circle {
                width: 32px;
                height: 32px;
            }

            .table-number {
                font-size: 9px;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <div style="display: flex; justify-content: space-between; align-items: start;">
            <div>
                <h1>Guest Management</h1>
                <p class="subtitle">Owais & Sadia Wedding - December 21, 2025</p>
                <p class="venue-info">Chateau Le Jardin Event Venue</p>
            </div>
            <button class="btn btn-cancel" onclick="logout()" style="padding: 10px 20px;">Logout</button>
        </div>
    </div>

    <div class="stats">
        <div class="stat-card">
            <div class="stat-number" id="totalGuests">0</div>
            <div class="stat-label">Total Guests</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="occupiedTables">0</div>
            <div class="stat-label">Tables Occupied</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">75</div>
            <div class="stat-label">Total Tables</div>
        </div>
    </div>

    <div class="controls">
        <div class="actions">
            <button class="btn btn-primary" onclick="openAddModal()">+ Add Guest</button>
            <label class="file-upload-label">
                ðŸ“¤ Upload Excel
                <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" onchange="handleFileUpload(event)">
            </label>
        </div>
        <div class="zoom-controls">
            <button class="btn btn-zoom" onclick="zoomOut()">âˆ’</button>
            <span style="color: #6a5a6a; font-size: 14px;" id="zoomLevel">100%</span>
            <button class="btn btn-zoom" onclick="zoomIn()">+</button>
        </div>
    </div>

    <div class="floor-plan-wrapper">
        <div class="floor-plan" id="floorPlan">
            <div class="stage">40' x 12'</div>
        </div>
    </div>
</div>

<!-- Add/Edit Guest Modal -->
<div class="modal" id="guestModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle">Add Guest</h2>
        </div>
        <form id="guestForm">
            <div class="form-group">
                <label>Guest Name *</label>
                <input type="text" id="guestName" required placeholder="Enter full name">
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Table Number *</label>
                    <input type="number" id="tableNumber" min="1" max="75" required placeholder="1-75">
                </div>
                <div class="form-group">
                    <label>Phone (Optional)</label>
                    <input type="tel" id="guestPhone" placeholder="+1 (555) 123-4567">
                </div>
            </div>

            <div class="form-group">
                <label>Email (Optional)</label>
                <input type="email" id="guestEmail" placeholder="guest@example.com">
            </div>

            <div class="extra-guests-section">
                <div class="section-title">Additional Guests</div>

                <div id="extraGuestsList">
                    <!-- Extra guests will be added here dynamically -->
                </div>

                <button type="button" class="btn-add-extra" onclick="addExtraGuestField()">+ Add Named Guest</button>

                <div class="extra-count-section">
                    <label>Unnamed Additional Guests</label>
                    <input type="number" id="extraGuestsCount" min="0" value="0" placeholder="0">
                    <p>Use this if you don't have names for additional guests (e.g., "plus 2")</p>
                </div>
            </div>

            <div class="modal-actions">
                <button type="button" class="btn btn-cancel" onclick="closeModal()">Cancel</button>
                <button type="submit" class="btn btn-primary" id="submitBtn">Add Guest</button>
            </div>
        </form>
    </div>
</div>

<!-- Table Details Modal -->
<div class="modal" id="tableModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="tableModalTitle">Table 1</h2>
            <p id="tableModalStats" style="font-size: 13px; color: #8a7a8a; margin-top: 8px;"></p>
        </div>
        <div class="guest-list" id="tableGuestList"></div>
        <div class="modal-actions">
            <button type="button" class="btn btn-cancel" onclick="closeTableModal()">Close</button>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
    let guests = [];
    let zoomScale = 1;
    let extraGuestsCounter = 0;
    let editingGuestId = null;

    // Add extra guest field
    function addExtraGuestField(name = '', table = '') {
        extraGuestsCounter++;
        const container = document.getElementById('extraGuestsList');
        const div = document.createElement('div');
        div.className = 'extra-guest-entry';
        div.id = `extra-guest-${extraGuestsCounter}`;
        div.innerHTML = `
                <div style="flex: 1;">
                    <input type="text" placeholder="Guest name" value="${name}" class="extra-guest-name" style="width: 100%; padding: 12px; border: 2px solid #d4b8c8; border-radius: 8px; font-family: 'Cinzel', serif; font-size: 14px; outline: none;">
                </div>
                <div style="flex: 1;">
                    <input type="number" placeholder="Table" min="1" max="75" value="${table}" class="extra-guest-table" style="width: 100%; padding: 12px; border: 2px solid #d4b8c8; border-radius: 8px; font-family: 'Cinzel', serif; font-size: 14px; outline: none;">
                </div>
                <button type="button" class="btn-remove-extra" onclick="removeExtraGuestField(${extraGuestsCounter})">Ã—</button>
            `;
        container.appendChild(div);
    }

    function removeExtraGuestField(id) {
        const element = document.getElementById(`extra-guest-${id}`);
        if (element) {
            element.remove();
        }
    }

    function getExtraGuests() {
        const extraGuests = [];
        const entries = document.querySelectorAll('.extra-guest-entry');
        entries.forEach(entry => {
            const name = entry.querySelector('.extra-guest-name').value.trim();
            const table = entry.querySelector('.extra-guest-table').value;
            if (name && table) {
                extraGuests.push({
                    name: name,
                    tableNumber: parseInt(table)
                });
            }
        });
        return extraGuests;
    }

    function clearExtraGuestFields() {
        document.getElementById('extraGuestsList').innerHTML = '';
        extraGuestsCounter = 0;
    }

    function populateEditForm(guest) {
        editingGuestId = guest._id;
        document.getElementById('modalTitle').textContent = 'Edit Guest';
        document.getElementById('guestName').value = guest.name;
        document.getElementById('tableNumber').value = guest.tableNumber;
        document.getElementById('guestEmail').value = guest.email || '';
        document.getElementById('guestPhone').value = guest.phone || '';
        document.getElementById('extraGuestsCount').value = guest.extraGuestsCount || 0;

        // Clear and populate extra guests
        clearExtraGuestFields();
        if (guest.extraGuests && guest.extraGuests.length > 0) {
            guest.extraGuests.forEach(extra => {
                addExtraGuestField(extra.name, extra.tableNumber);
            });
        }

        document.getElementById('submitBtn').textContent = 'Update Guest';
        document.getElementById('guestModal').classList.add('show');
    }

    // Table positions matching the floor plan image
    const tablePositions = {
        // Left section - 4 columns
        32: {x: 80, y: 150}, 31: {x: 160, y: 150}, 16: {x: 240, y: 150}, 15: {x: 320, y: 150},
        33: {x: 80, y: 230}, 30: {x: 160, y: 230}, 17: {x: 240, y: 230}, 14: {x: 320, y: 230},
        34: {x: 80, y: 310}, 29: {x: 160, y: 310}, 18: {x: 240, y: 310}, 13: {x: 320, y: 310},
        35: {x: 80, y: 390}, 28: {x: 160, y: 390}, 19: {x: 240, y: 390}, 12: {x: 320, y: 390},
        36: {x: 80, y: 470}, 27: {x: 160, y: 470}, 20: {x: 240, y: 470}, 11: {x: 320, y: 470},
        37: {x: 80, y: 550}, 26: {x: 160, y: 550}, 21: {x: 240, y: 550}, 10: {x: 320, y: 550},
        38: {x: 80, y: 630}, 25: {x: 160, y: 630}, 22: {x: 240, y: 630}, 9: {x: 320, y: 630},
        39: {x: 80, y: 710}, 24: {x: 160, y: 710}, 23: {x: 240, y: 710}, 8: {x: 320, y: 710},

        // Center-left (rectangular tables)
        2: {x: 420, y: 280}, 3: {x: 420, y: 350}, 4: {x: 420, y: 420}, 5: {x: 420, y: 490},
        6: {x: 420, y: 560}, 7: {x: 420, y: 630},

        // Center-right (rectangular tables)
        1: {x: 720, y: 280}, 40: {x: 720, y: 350}, 41: {x: 720, y: 420}, 42: {x: 720, y: 490},
        43: {x: 720, y: 560}, 44: {x: 720, y: 630},

        // Right section - 4 columns
        52: {x: 820, y: 150}, 53: {x: 900, y: 150}, 68: {x: 980, y: 150}, 69: {x: 1060, y: 150},
        51: {x: 820, y: 230}, 54: {x: 900, y: 230}, 67: {x: 980, y: 230}, 70: {x: 1060, y: 230},
        50: {x: 820, y: 310}, 55: {x: 900, y: 310}, 66: {x: 980, y: 310}, 71: {x: 1060, y: 310},
        49: {x: 820, y: 390}, 56: {x: 900, y: 390}, 65: {x: 980, y: 390}, 72: {x: 1060, y: 390},
        48: {x: 820, y: 470}, 57: {x: 900, y: 470}, 64: {x: 980, y: 470}, 73: {x: 1060, y: 470},
        47: {x: 820, y: 550}, 58: {x: 900, y: 550}, 63: {x: 980, y: 550}, 74: {x: 1060, y: 550},
        46: {x: 820, y: 630}, 59: {x: 900, y: 630}, 62: {x: 980, y: 630}, 75: {x: 1060, y: 630},
        45: {x: 820, y: 710}, 60: {x: 900, y: 710}, 61: {x: 980, y: 710},
    };

    function initializeFloorPlan() {
        const floorPlan = document.getElementById('floorPlan');

        // Create all tables based on positions
        Object.entries(tablePositions).forEach(([tableNum, pos]) => {
            const isRectangular = [1, 2, 3, 4, 5, 6, 7, 40, 41, 42, 43, 44].includes(parseInt(tableNum));

            const table = document.createElement('div');
            table.className = isRectangular ? 'table-rect' : 'table-circle';
            table.id = `table-${tableNum}`;
            table.style.left = `${pos.x}px`;
            table.style.top = `${pos.y}px`;
            table.innerHTML = `<div class="table-number">${tableNum}</div>`;
            table.onclick = () => showTableDetails(parseInt(tableNum));

            floorPlan.appendChild(table);
        });
    }

    function zoomIn() {
        if (zoomScale < 1.5) {
            zoomScale += 0.1;
            updateZoom();
        }
    }

    function zoomOut() {
        if (zoomScale > 0.5) {
            zoomScale -= 0.1;
            updateZoom();
        }
    }

    function updateZoom() {
        const floorPlan = document.getElementById('floorPlan');
        floorPlan.style.transform = `scale(${zoomScale})`;
        document.getElementById('zoomLevel').textContent = `${Math.round(zoomScale * 100)}%`;
    }

    function updateTableDisplay() {
        const tableCounts = {};
        guests.forEach(guest => {
            tableCounts[guest.table] = (tableCounts[guest.table] || 0) + 1;
        });

        for (let i = 1; i <= 75; i++) {
            const tableElement = document.getElementById(`table-${i}`);
            if (tableElement) {
                const count = tableCounts[i] || 0;
                if (count > 0) {
                    tableElement.classList.add('occupied');
                } else {
                    tableElement.classList.remove('occupied');
                }
            }
        }

        updateStats();
    }

    function updateStats() {
        document.getElementById('totalGuests').textContent = guests.length;
        const occupiedTables = new Set(guests.map(g => g.table)).size;
        document.getElementById('occupiedTables').textContent = occupiedTables;
    }

    function showTableDetails(tableNumber) {
        const tableGuests = guests.filter(g => g.table === tableNumber);
        document.getElementById('tableModalTitle').textContent = `Table ${tableNumber}`;

        const guestList = document.getElementById('tableGuestList');
        if (tableGuests.length === 0) {
            guestList.innerHTML = '<p style="text-align: center; color: #8a7a8a;">No guests assigned to this table</p>';
        } else {
            guestList.innerHTML = tableGuests.map(guest => `
                    <div class="guest-item">
                        <span class="guest-name">${guest.name}</span>
                        <button class="btn-remove" onclick="removeGuest(${guest.id})">Remove</button>
                    </div>
                `).join('');
        }

        document.getElementById('tableModal').classList.add('show');
    }

    function closeTableModal() {
        document.getElementById('tableModal').classList.remove('show');
    }

    async function removeGuest(id) {
        if (confirm('Are you sure you want to remove this guest?')) {
            try {
                const response = await fetch(`/api/guests/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    guests = guests.filter(g => g.id !== id);
                    updateTableDisplay();
                    const modalTitle = document.getElementById('tableModalTitle').textContent;
                    const tableNumber = parseInt(modalTitle.split(' ')[1]);
                    showTableDetails(tableNumber);
                }
            } catch (error) {
                console.error('Error removing guest:', error);
                guests = guests.filter(g => g.id !== id);
                updateTableDisplay();
                const modalTitle = document.getElementById('tableModalTitle').textContent;
                const tableNumber = parseInt(modalTitle.split(' ')[1]);
                showTableDetails(tableNumber);
            }
        }
    }

    function openAddModal() {
        editingGuestId = null;
        document.getElementById('modalTitle').textContent = 'Add Guest';
        document.getElementById('submitBtn').textContent = 'Add Guest';
        document.getElementById('guestForm').reset();
        clearExtraGuestFields();
        document.getElementById('extraGuestsCount').value = '0';
        document.getElementById('guestModal').classList.add('show');
    }

    function closeModal() {
        document.getElementById('guestModal').classList.remove('show');
        editingGuestId = null;
    }

    function closeModal() {
        document.getElementById('guestModal').classList.remove('show');
    }

    document.getElementById('guestForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const guestData = {
            name: document.getElementById('guestName').value,
            table: parseInt(document.getElementById('tableNumber').value)
        };

        try {
            const response = await fetch('/api/guests', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(guestData)
            });

            if (response.ok) {
                const newGuest = await response.json();
                guests.push(newGuest);
                updateTableDisplay();
                closeModal();
            }
        } catch (error) {
            console.error('Error adding guest:', error);
            guestData.id = Date.now();
            guests.push(guestData);
            updateTableDisplay();
            closeModal();
        }
    });

    async function handleFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                // Expected format: name, tableNumber, email (optional), phone (optional), extraGuestsCount (optional)
                const newGuests = jsonData.map(row => ({
                    name: row.name || row.Name || row.NAME,
                    tableNumber: parseInt(row.tableNumber || row['Table Number'] || row.table || row.Table || row.TABLE),
                    email: row.email || row.Email || row.EMAIL || undefined,
                    phone: row.phone || row.Phone || row.PHONE || undefined,
                    extraGuestsCount: parseInt(row.extraGuestsCount || row['Extra Guests'] || row.extras || 0) || 0
                }));

                const token = localStorage.getItem('adminToken');

                const response = await fetch('/api/guests/bulk', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(newGuests)
                });

                if (response.status === 401 || response.status === 403) {
                    localStorage.removeItem('adminToken');
                    window.location.href = '/admin/login';
                    return;
                }

                if (response.ok) {
                    const result = await response.json();
                    await loadGuests(); // Reload all guests from server
                    alert(result.message + (result.errors ? `\n\nErrors:\n${result.errors.join('\n')}` : ''));
                } else {
                    const error = await response.json();
                    alert(error.error || 'Failed to upload guests');
                }
            } catch (error) {
                console.error('Error processing file:', error);
                alert('Error processing file. Please ensure it has "name" and "tableNumber" columns.');
            }
        };
        reader.readAsArrayBuffer(file);
        event.target.value = '';
    }

    document.getElementById('guestModal').addEventListener('click', (e) => {
        if (e.target.id === 'guestModal') closeModal();
    });

    document.getElementById('tableModal').addEventListener('click', (e) => {
        if (e.target.id === 'tableModal') closeTableModal();
    });

    async function loadGuests() {
        // Check authentication
        const token = localStorage.getItem('adminToken');
        if (!token) {
            window.location.href = '/admin/login';
            return;
        }

        try {
            const response = await fetch('/api/guests', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.status === 401 || response.status === 403) {
                // Token invalid or expired
                localStorage.removeItem('adminToken');
                window.location.href = '/admin/login';
                return;
            }

            if (response.ok) {
                guests = await response.json();
                updateTableDisplay();
            }
        } catch (error) {
            console.error('Error loading guests:', error);
        }
    }

    // Add logout functionality
    function logout() {
        localStorage.removeItem('adminToken');
        window.location.href = '/admin/login';
    }

    initializeFloorPlan();
    loadGuests();
</script>
</body>
</html>